<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Plantory - 나눔 게시글 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- 고정 헤더 -->
<div th:replace="fragments/header :: headerBar"></div>

<div class="container my-4">
    <div class="mb-3">
        <h5 class="fw-bold">나눔 게시글 등록</h5>
        <hr>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- 식물 이미지 업로드/미리보기 -->
            <div class="mb-3">
                <label class="form-label small fw-semibold">식물 이미지</label>
                <div class="d-flex align-items-start gap-2 flex-wrap">
                    <div id="previewList" class="d-flex flex-wrap gap-2">
                        <!-- 기존 이미지 예시 (생략 가능) -->
                        <!-- ... 기존 썸네일들 ... -->
                    </div>

                    <input id="imageInput" type="file" class="d-none" accept="image/*" multiple>
                    <label for="imageInput" class="border rounded d-inline-flex flex-column align-items-center justify-content-center"
                           style="width:90px;height:90px;cursor:pointer;">
                        <i class="bi bi-camera fs-3 text-secondary"></i>
                    </label>
                </div>
            </div>

            <!-- 변경된 영역: 셀렉트 → 입력 + 모달 버튼 -->
            <div class="row g-2 mb-3 align-items-end">
                <div class="col-12 col-md-6">
                    <label class="form-label small fw-semibold">식물 종류 <span class="text-danger">*</span></label>
                    <div class="d-flex gap-2">
                        <div class="d-flex gap-2">
                            <input
                                    type="text"
                                    class="form-control form-control-sm"
                                    placeholder="식물 종류 입력"
                            />
                            <button
                                    type="button"
                                    class="btn btn-dark btn-sm px-3 text-nowrap"
                                    data-bs-toggle="modal"
                                    data-bs-target="#plantSearchModal"
                            >
                                불러오기
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small fw-semibold">상태</label>
                    <input id="plantConditionInput" type="text" class="form-control form-control-sm" value="양호" disabled>
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small fw-semibold">관리 난이도</label>
                    <input id="plantDifficultyInput" type="text" class="form-control form-control-sm" value="낮음" disabled>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-semibold">제목 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" placeholder="제목을 입력하세요">
            </div>

            <div class="mb-4">
                <label class="form-label small fw-semibold">설명 <span class="text-danger">*</span></label>
                <textarea class="form-control" rows="6" placeholder="내용을 입력하세요"></textarea>
            </div>

            <div class="d-flex justify-content-center gap-2">
                <a href="/sharingDetail" class="btn btn-secondary px-4">취소</a>
                <a href="/sharingDetail" class="btn btn-success px-4">수정</a>
            </div>
        </div>
    </div>
</div>

<!-- 식물 검색 모달 -->
<div class="modal fade" id="plantSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold mb-0">식물 검색</h6>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small mb-1">식물명</label>
                    <div class="input-group input-group-sm">
                        <input id="plantSearchInput" type="text" class="form-control" placeholder="식물 이름을 입력하세요.">
                        <button class="input-group-text" id="plantSearchBtn" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- 검색 결과 리스트 (샘플) -->
                <div id="plantResultList" class="vstack gap-2">
                    <div class="border rounded d-flex align-items-center p-2">
                        <img src="https://images.pexels.com/photos/4505162/pexels-photo-4505162.jpeg?auto=compress&cs=tinysrgb&w=200"
                             alt="산세베리아" class="me-2" style="width:50px;height:50px;object-fit:cover;">
                        <div class="flex-grow-1 small">산세베리아</div>
                        <button type="button" class="btn btn-success btn-sm px-3 text-nowrap plant-select-btn"
                                data-plant-name="산세베리아" data-condition="양호" data-difficulty="낮음"
                                data-bs-dismiss="modal">
                            선택
                        </button>
                    </div>

                    <div class="border rounded d-flex align-items-center p-2">
                        <img src="https://images.pexels.com/photos/3076899/pexels-photo-3076899.jpeg?auto=compress&cs=tinysrgb&w=200"
                             alt="산세베리아 ‘골든 하나’" class="me-2" style="width:50px;height:50px;object-fit:cover;">
                        <div class="flex-grow-1 small">산세베리아 ‘골든 하나’</div>
                        <button type="button" class="btn btn-success btn-sm px-3 text-nowrap plant-select-btn"
                                data-plant-name="산세베리아 ‘골든 하나’" data-condition="보통" data-difficulty="낮음"
                                data-bs-dismiss="modal">
                            선택
                        </button>
                    </div>

                    <button type="button" class="btn btn-secondary btn-sm px-3 py-1 align-self-center" data-bs-dismiss="modal">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* 업로드 미리보기: 최대 5장, 삭제 지원 */
    (function () {
        const MAX_IMAGES = 5;
        const previewList = document.getElementById('previewList');
        const imageInput  = document.getElementById('imageInput');

        previewList.addEventListener('click', function(e){
            const btn = e.target.closest('.remove-btn');
            if (!btn) return;
            const wrap = btn.closest('.thumb');
            const img  = wrap.querySelector('img');
            if (img && img.dataset.blobUrl === 'true') URL.revokeObjectURL(img.src);
            wrap.remove();
        });

        imageInput.addEventListener('change', function () {
            const files = Array.from(this.files || []);
            if (!files.length) return;

            const current = previewList.querySelectorAll('.thumb').length;
            if (current >= MAX_IMAGES) { alert('이미지는 최대 5장까지 등록 가능합니다.'); this.value=''; return; }

            const remain = MAX_IMAGES - current;
            files.slice(0, remain).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const url = URL.createObjectURL(file);

                const item = document.createElement('div');
                item.className = 'thumb position-relative border rounded p-1';
                item.style.width = '90px';
                item.style.height = '90px';
                item.innerHTML = `
          <img src="${url}" data-blob-url="true" class="w-100 h-100 rounded" style="object-fit:cover;" alt="preview">
          <button type="button" class="remove-btn position-absolute top-0 start-100 translate-middle btn btn-sm p-0 border-0" aria-label="remove image">
            <span class="badge rounded-pill bg-danger d-inline-flex align-items-center justify-content-center" style="width:18px;height:18px;">
              <i class="bi bi-x-lg"></i>
            </span>
          </button>
        `;
                previewList.appendChild(item);
            });

            this.value = ''; // 같은 파일 재선택 허용
        });
    })();

    /* 식물 선택: 모달에서 값 주입 */
    (function () {
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.plant-select-btn');
            if (!btn) return;

            const name = btn.dataset.plantName || '';
            const cond = btn.dataset.condition || '';
            const diff = btn.dataset.difficulty || '';

            const nameInput = document.getElementById('plantNameInput');
            const condInput = document.getElementById('plantConditionInput');
            const diffInput = document.getElementById('plantDifficultyInput');

            if (nameInput) nameInput.value = name;
            if (condInput) condInput.value = cond;
            if (diffInput) diffInput.value = diff;
        });

        // 검색 버튼(샘플: 실제 검색 API 연동 전 기본 동작 유지)
        document.getElementById('plantSearchBtn')?.addEventListener('click', function(){
            // TODO: 컨트롤러 연동 시 검색 결과 DOM 업데이트
            // 현재는 샘플 고정 리스트 유지
        });
    })();
</script>
</body>
</html>